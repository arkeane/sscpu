<!DOCTYPE html>
<html>

<head>
    <title>SSCPU</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
</head>

<body>
    <script type="module">
        import init, { sanity_check, cpu_run } from "./pkg/sscpu.js";

        await init();

        window.exec = function runcpu(program, data) {
            return cpu_run(program, data);
        }
    </script>

    <script>
        function run() {
            const program_text = document.getElementById("program").value;
            const data_text = document.getElementById("data").value;

            // convert each line first 16 chars of program_text to a number from binary to decimal
            const program = program_text.split("\n").map(line => parseInt(line.substring(0, 16), 2));
            // convert each line first 16 chars of data_text to a number from binary to decimal
            const data = data_text.split("\n").map(line => parseInt(line.substring(0, 16), 2));

            JsValue = window.exec(program, data);
            // send the json registers to registers textarea
            document.getElementById("registers").value = JSON.stringify(JsValue.registers);
            // send the json memory to memory textarea
            document.getElementById("memory").value = JSON.stringify(JsValue.memory);
            // send the json stack to stack textarea
            document.getElementById("stack").value = JSON.stringify(JsValue.stack);
            // send the json pc to pc textarea
            document.getElementById("pc").value = JSON.stringify(JsValue.pc);
            // send the json sp to sp textarea
            document.getElementById("sp").value = JSON.stringify(JsValue.sp);
        }

        function load_from_file() {
            // open file
            const file = document.getElementById("ssasm").files[0];
            const reader = new FileReader();
            // split file into program and data using --data-- as a delimiter
            reader.onload = function (e) {
                const text = e.target.result;
                const split = text.split("--data--");
                document.getElementById("program").value = split[0];
                // delete last line from program as it is empty
                document.getElementById("program").value = document.getElementById("program").value.substring(0, document.getElementById("program").value.length - 1);
                document.getElementById("data").value = split[1];
                // delete first line from data
                document.getElementById("data").value = document.getElementById("data").value.substring(document.getElementById("data").value.indexOf("\n") + 1);
            }
            reader.readAsText(file);
        }

        // download a file from server and load it into the program and data textareas
        function load_from_server() {
            const request = new XMLHttpRequest();
            request.open("GET", "./ssasm/conditional.ssasm", true);
            request.onload = function (e) {
                const text = e.target.response;
                const split = text.split("--data--");
                document.getElementById("program").value = split[0];
                // delete last line from program as it is empty
                document.getElementById("program").value = document.getElementById("program").value.substring(0, document.getElementById("program").value.length - 1);
                document.getElementById("data").value = split[1];
                // delete first line from data
                document.getElementById("data").value = document.getElementById("data").value.substring(document.getElementById("data").value.indexOf("\n") + 1);
            }
            request.send();
        }
    </script>



    <div class="container">
        <h1>SSCPU WASM Emulator</h1><br>
        <div class="container">
            <button type="button" class="btn btn-secondary" onclick="load_from_server()">Load SSASM example</button>
            <a href="./ssasm/conditional.ssasm" download="conditional.ssasm" class="btn btn-secondary">Download SSASM example</a>
        </div>
        <div class="row">
            <div class="col">
                <br><label class="form-label" for="program">Instructions</label>
                <textarea class="form-control" id="program" rows="10" cols="50"></textarea>
                <label class="form-label" for="data">--data--</label>
                <textarea class="form-control" id="data" rows="10" cols="50"></textarea><br>
                <div class="input-group">
                    <input type="file" class="form-control" id="ssasm" aria-describedby="inputGroupFileAddon04"
                        aria-label="Upload" onchange="load_from_file()">
                    <button class="btn btn-primary" type="button" onclick="run()">RUN</button>
                </div>
            </div>
            <div class="col">
                <h2 class="title">OUTPUT</h2><br>
                <label class="form-label" for="registers">Registers</label>
                <textarea disabled class="form-control" id="registers" rows="1"></textarea>
                <label class="form-label" for="memory">Memory</label>
                <textarea disabled class="form-control" id="memory" rows="7"></textarea>
                <label class="form-label" for="stack">Stack</label>
                <textarea disabled class="form-control" id="stack" rows="1"></textarea>
                <label class="form-label" for="pc">PC</label>
                <textarea disabled class="form-control" id="pc" rows="1"></textarea>
                <label class="form-label" for="sp">SP</label>
                <textarea disabled class="form-control" id="sp" rows="1"></textarea>
            </div>
        </div>
    </div>

    <br>
    <div class="container">
        <h1>Instruction Set</h1>
        <table class="table table-striped">
            <tr>
                <td>Opcode</td>
                <td>Option</td>
                <td>From</td>
                <td>To</td>
                <td>Instruction</td>
                <td>Description</td>
            </tr>
            <tr>
                <td>0000</td>
                <td>0000</td>
                <td>0000</td>
                <td>0000</td>
                <td>HALT</td>
                <td>Halt the CPU</td>
            </tr>
            <tr>
                <td>0001</td>
                <td>0000</td>
                <td>R</td>
                <td>0000</td>
                <td>PUSH</td>
                <td>Pushes the value of register R onto the stack, if stack pointer is = 256 Stack Overflow is thrown
                </td>
            </tr>
            <tr>
                <td>0010</td>
                <td>0000</td>
                <td>0000</td>
                <td>R</td>
                <td>POP</td>
                <td>Pops the value of the stack into registe R, if stack pointer is = 0 Stack Out of Bound is thrown
                </td>
            </tr>
            <tr>
                <td>0011</td>
                <td>0000</td>
                <td>R1</td>
                <td>R0</td>
                <td>MOV</td>
                <td>Moves the value of register R1 into register R0</td>
            </tr>
            <tr>
                <td>0100</td>
                <td></td>
                <td>12-bit PC Address</td>
                <td></td>
                <td>JMP</td>
                <td>Jumps to the address specified by the 12-bit Address</td>
            </tr>
            <tr>
                <td>0101</td>
                <td>Offset(4-bit)</td>
                <td>R1</td>
                <td>R0</td>
                <td>BEQ</td>
                <td>Sets PC+=Offset if R0 == R1</td>
            </tr>
            <tr>
                <td>0110</td>
                <td>Offset(4-bit)</td>
                <td>R1</td>
                <td>R0</td>
                <td>BNE</td>
                <td>Sets PC+=Offset if R0 != R1</td>
            </tr>
            <tr>
                <td>0111</td>
                <td>R</td>
                <td>8-bit Memory Address</td>
                <td></td>
                <td>STOR</td>
                <td>Store the value of R0 into Memory[Address]</td>
            </tr>
            <tr>
                <td>1000</td>
                <td>R</td>
                <td>8-bit Memory Address</td>
                <td></td>
                <td>LOAD</td>
                <td>Loads the value of Memory[Address] into R0</td>
            </tr>
            <tr>
                <td>1001</td>
                <td>0000</td>
                <td>A</td>
                <td>R</td>
                <td>ADDI</td>
                <td>Adds the value of A to the value of R0 and stores it in R0</td>
            </tr>
            <tr>
                <td>1010</td>
                <td>0000</td>
                <td>R1</td>
                <td>R0</td>
                <td>ADDR</td>
                <td>Adds the value of R1 to the value of R0 and stores it in R0</td>
            </tr>
            <tr>
                <td>1011</td>
                <td>0000</td>
                <td>A</td>
                <td>R</td>
                <td>SUBI</td>
                <td>Subtracts the value of A from the value of R0 and stores it in R0 if A > R0, R0 is set to 0 </td>
            </tr>
            <tr>
                <td>1100</td>
                <td>0000</td>
                <td>R1</td>
                <td>R0</td>
                <td>SUBR</td>
                <td>Subtracts the value of R1 from the value of R0 and stores it in R0 if R1 > R0, R0 is set to 0 </td>
            </tr>
            <tr>
                <td>1101</td>
                <td>0000</td>
                <td>A</td>
                <td>R</td>
                <td>MULI</td>
                <td>Multiply the value of A to the value of R0 and store the result in R0</td>
            </tr>
            <tr>
                <td>1110</td>
                <td>0000</td>
                <td>R1</td>
                <td>R0</td>
                <td>MULR</td>
                <td>Multiply the value of R1 to the value of R0 and store the result in R0</td>
            </tr>
            <tr>
                <td>1111</td>
                <td>0000</td>
                <td>0000</td>
                <td>0000</td>
                <td>NOP</td>
                <td>No Operation (Waste 1 CPU cycle)</td>
            </tr>

        </table>
    </div>

</body>

</html>